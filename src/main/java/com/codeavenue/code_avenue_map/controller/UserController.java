package com.codeavenue.code_avenue_map.controller;

import com.codeavenue.code_avenue_map.exception.UnauthorizedAccessException;
import com.codeavenue.code_avenue_map.exception.UserNotFoundException;
import com.codeavenue.code_avenue_map.model.CustomUserDetails;
import com.codeavenue.code_avenue_map.model.Role;
import com.codeavenue.code_avenue_map.model.User;
import com.codeavenue.code_avenue_map.model.dto.UserUpdateDTO;
import com.codeavenue.code_avenue_map.service.UserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/users")
@Tag(name = "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", description = "Endpoints Ù„Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†")
@SecurityRequirement(name = "bearerAuth")
public class UserController {

    private final UserService userService;
    private static final Logger logger = LoggerFactory.getLogger(UserController.class);

    public UserController(UserService userService) {
        this.userService = userService;
    }

    @PutMapping(value = "/{id}", produces = MediaType.APPLICATION_JSON_VALUE)
    @Operation(summary = "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", description = "ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ø®Ø§ØµØ© ÙÙ‚Ø·ØŒ Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù….")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­"),
            @ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±"),
            @ApiResponse(responseCode = "409", description = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„"),
            @ApiResponse(responseCode = "404", description = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    })
    public ResponseEntity<User> updateUser(@PathVariable Long id, @RequestBody UserUpdateDTO updatedUser) {
        CustomUserDetails currentUser = (CustomUserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        User currentUserObj = currentUser.getUser();

        logger.info("ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {} Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: {} | Ø¯ÙˆØ±Ù‡: {}", id, currentUserObj.getId(), currentUserObj.getRole());

        if (!currentUserObj.getId().equals(id) && currentUserObj.getRole() != Role.ADMIN && currentUserObj.getRole() != Role.SUPER_ADMIN) {
            throw new UnauthorizedAccessException("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹.");
        }

        User updatedUserProfile = userService.updateUserProfile(id, updatedUser, currentUserObj.getId());
        logger.info("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ({}) Ø¨Ù†Ø¬Ø§Ø­!", id);
        return ResponseEntity.ok(updatedUserProfile);
    }

    @GetMapping(value = "/me", produces = MediaType.APPLICATION_JSON_VALUE)
    @Operation(summary = "Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ", description = "ÙŠØªÙŠØ­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†.")
    public ResponseEntity<User> getCurrentUser() {
        CustomUserDetails currentUser = (CustomUserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        User user = userService.getUserById(currentUser.getUser().getId())
                .orElseThrow(() -> new UserNotFoundException(currentUser.getUser().getId()));

        return ResponseEntity.ok().contentType(MediaType.APPLICATION_JSON).body(user);
    }
}
